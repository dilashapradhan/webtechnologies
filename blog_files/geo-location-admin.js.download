(function($,google){window.geolocationLoadMapAPI=function(){};var existingLocation,location,initialized=false,panel=null,searchField,progressField,locationField,dialogField,errorField,geolocationSupported=window.navigator.geolocation!==undefined,map=null,marker=null,isOpen=false,googleMapsLoaded=false,i18n=geolocationI18N,loadLib=function(){if(!google){return;}
if(googleMapsLoaded){return;}
googleMapsLoaded=true;google.load("maps","3",{"other_params":geolocationI18N.api_key,"callback":"geolocationLoadMapAPI"});},methods={'init':function(options){var context=this;if(!initialized){initialized=true;methods.buildPanel.call(this);this.on('click',function(e){e.preventDefault();methods.toggle.call(context);});}
if(options&&options.location){methods.setLocation.call(context,options.location);if(methods.hasExistingLocation.call(context)){loadLib();}}
if(!google){setTimeout(function(){context.trigger('locationDisabled');},1);}
return this;},'toggle':function(){if(isOpen){methods.close.call(this);}else{methods.open.call(this);}},'buildPanel':function(){var context=this;panel=$("<div class=\"geolocation-panel-container\"></div>")
.addClass('geolocation-panel');searchField=$("<span><a class=\"button disabled\" href=\"#locate\">Locate</a><span class=\"geolocation-search-input\"><input id='geolocation-search-input' type=\"text\" placeholder='Address' /><label for='geolocation-search-input'>Current Location</label></span></span>")
.addClass('geolocation-search-field')
.appendTo(panel);searchField.find('label').text(i18n.current_location);searchField.find('a').text(i18n.locate);searchField.find('input').attr('placeholder',i18n.address);progressField=$("<span><span class=\"spinner\"></span><span class=\"progress-message\">Locating</span></span>")
.addClass('geolocation-progress-field')
.appendTo(panel)
.hide();progressField.find('.progress-message').text(i18n.locating);dialogField=$("<span><a class=\"button\" href=\"#search\">Search</a><a class=\"button-primary\" href=\"#use\">Use</a><span></span></span>")
.addClass('geolocation-dialog-field')
.appendTo(panel)
.hide();dialogField.find('[href="#search"]').text(i18n.search);dialogField.find('[href="#use"]').text(i18n.use);locationField=$("<span>Location, US</span>")
.addClass('geolocation-location-field')
.appendTo(panel)
.hide();errorField=$("<span><a class=\"button\" href=\"#search\">Back</a><span>Location not found.</span></span>")
.addClass('geolocation-error-field')
.appendTo(panel)
.hide();errorField.find('a').text(i18n.text);errorField.find('span').text(i18n.error);if(geolocationSupported){searchField.find('a').removeClass('disabled');searchField.find('input').attr('placeholder','');}else{searchField.find('label').hide();}},'open':function(){loadLib();var context=this;isOpen=true;panel.insertAfter('#wp-content-media-buttons');methods.position.call(this,panel);setTimeout(function(){$(document.body).on('click.geolocationPicker',function(e){if(!$(e.target).parents().andSelf().is($(panel,context))){e.preventDefault();methods.close.call(context);}});},1);$(window).one('resize',function(){methods.close.call(context);});panel.on('keyup.geolocationPicker','input',function(e){var input=searchField.find('input').val();disable=!geolocationSupported&&input==="";searchField.find('a').toggleClass('disabled',disable);if(!geolocationSupported){return;}
searchField.find('label')[input===''?'show':'hide']();});panel.on('keydown.geolocationPicker','input',function(e){if(e.which==13){e.preventDefault();searchField.find('a').trigger('click.geolocationPicker');}else if(e.which==27){e.preventDefault();methods.close.call(context);}});panel.on('click.geolocationPicker','[href="#locate"]',function(e){e.preventDefault();if(searchField.find('a').hasClass('disabled')){return;}
context.trigger('locating');var address=searchField.find('input').val();if(address===''&&geolocationSupported){methods.locate.call(context);}else{methods.geocode.call(context,{'address':searchField.find('input').val()});}});panel.on('click.geolocationPicker','[href="#use"]',function(e){e.preventDefault();if(methods.hasLocation()){context.trigger('locationPicked',[location]);}else{context.trigger('locationRemoved');}});panel.on('click.geolocationPicker','[href="#search"]',function(e){e.preventDefault();methods.removeMap.call(context);searchField.show();locationField.hide();dialogField.hide();progressField.hide();errorField.hide();});this.on('locating.geolocationPicker',function(){searchField.hide();locationField.hide();dialogField.hide();errorField.hide();progressField.show();errorField.hide();});this.on('located.geolocationPicker',function(e,found,result){locationField.show();dialogField.show();searchField.hide();errorField.hide();progressField.hide();methods.displayLocation.call(context,found,result);});this.on('locationRemoved.geolocationPicker',function(){locationField.hide();dialogField.hide();searchField.show();progressField.hide();errorField.hide();methods.clearLocation.call(context);methods.close.call(context);});this.on('locationPicked.geolocationPicker',function(e,location){methods.setLocation.call(context,location);methods.close.call(context);});this.on('locationError.geolocationPicker',function(e){locationField.hide();dialogField.hide();searchField.hide();progressField.hide();errorField.show();});if(methods.hasExistingLocation.call(context)){this.trigger('located',existingLocation);}
searchField.find('input').focus();},'close':function(){$(document.body).off('click.geolocationPicker');panel.remove();methods.removeMap.call(this);panel.off('.geolocationPicker');this.off('.geolocationPicker');isOpen=false;},'position':function(panel){var anchor=this.position();if($(window).width()>=780){panel
.css({'position':'absolute','top':anchor.top-10,'left':anchor.left+this.outerWidth(),'z-index':1000,'width':'320'})
.removeClass('inline');var rightEdge=panel.offset().left+panel.outerWidth(),rightEdgeLimit=$(window).width()-10;if(rightEdge>rightEdgeLimit){panel.css({'left':panel.position().left+rightEdgeLimit-rightEdge});}}else{panel
.css({'position':'relative','width':'auto','left':0,'top':0})
.addClass('inline');}},'hasExistingLocation':function(){if(!existingLocation){return false;}
var hasCoord=existingLocation.latitude&&existingLocation.longitude;return hasCoord;},'hasLocation':function(){var hasCoord=location&&location.latitude&&location.longitude;if(!hasCoord){return false;}
if(hasCoord&&!location.address){location.address=location.latitude+", "+location.longitude;}
return true;},'setLocation':function(newLocation){var hasCoords=newLocation&&newLocation.latitude&&newLocation.longitude;if(hasCoords&&!newLocation.address){newLocation.address=newLocation.latitude+", "+newLocation.longitude;}
if(hasCoords){existingLocation=newLocation;location=null;this
.text(newLocation.address)
.attr('title',newLocation.address)
.addClass('located');}},'clearLocation':function(){existingLocation=null;dialogField.find('[href="#use"]').text('Use');this
.text("Add Location")
.attr('title',null)
.removeClass('located');methods.removeMap.call(this);},'removeMap':function(){if(map){$(map.getDiv()).remove();map=null;}},'locate':function(){var context=this,onPosition=$.proxy(function(position){var coords=new google.maps.LatLng(position.coords.latitude,position.coords.longitude);methods.geocode.call(this,{'latLng':coords});},this),onError=$.proxy(function(){context.trigger('locationError');},this);window.navigator.geolocation.getCurrentPosition(onPosition,onError,{timeout:5000});},'geocode':function(query){var context=this,geocoder=new google.maps.Geocoder();geocoder.geocode(query,function(results,status){if(status==google.maps.GeocoderStatus.OK){var use_result=false,result,searched_geo=query.latLng;for(var i=0;i<results.length;i++){result=results[i];use_result=searched_geo?$.inArray('political',result.types)>-1:true;if(use_result){name=result.formatted_address;if(searched_geo){location={latitude:query.latLng.lat(),longitude:query.latLng.lng()};}else{location={latitude:result.geometry.location.lat(),longitude:result.geometry.location.lng(),};}
location.result=result;location.address=name;break;}}
if(use_result)context.trigger('located',[location,result]);}else{context.trigger('locationError');}});},'displayLocation':function(location,result){var latLng=new google.maps.LatLng(location.latitude,location.longitude);if(methods.hasLocation.call(this)){dialogField.find('[href="#use"]').text('Use');}else if(methods.hasExistingLocation.call(this)){dialogField.find('[href="#use"]').text('Remove');}
locationField.text(location.address);if(map===null){var mapNode=$('<div></div>')
.addClass('geolocation-map-container')
.css({'width':panel.width(),'height':Math.min(240,panel.width())})
.insertBefore(locationField);map=new google.maps.Map(mapNode.get(0),{center:result?result.geometry.location:latLng,zoom:9,draggable:false,streetViewControl:false,zoomControl:true,mapTypeControl:false,overviewMapControl:false,panControl:true,rotateControl:false,scaleControl:false});}
if(marker){marker.setMap(null);}
marker=new google.maps.Marker({map:map,position:latLng});if(result){map.fitBounds(result.geometry.viewport);}else{map.setCenter(latLng);}}};$.fn.geolocationPicker=function(){var args=[].slice.apply(arguments),methodName=$.type(args[0])==='string'?args.shift():'init',method=methods[methodName]||function(){throw("Method "+method+" does not exist for geolocationPicker");};return method.apply(this,args);};})(jQuery,window.google);